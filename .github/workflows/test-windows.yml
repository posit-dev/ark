name: "Test Ark - Windows"

on:
  workflow_call:
  workflow_dispatch:

jobs:
  windows:
    runs-on: windows-11-arm
    name: "Rust: ${{ matrix.config.rust }}, R: ${{ matrix.config.r }}"
    strategy:
      fail-fast: false
      matrix:
        config:
          - { rust: 'stable', r: 'release' }
    timeout-minutes: 30
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Report Rust Toolchain
        run: rustup show

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2

      - name: Install nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - name: Install R
        run: |
          curl -L -o R-installer.exe https://www.r-project.org/nosvn/winutf8/aarch64/R-4-signed/R-4.5.1-aarch64.exe
          Start-Process -Wait -FilePath .\R-installer.exe -ArgumentList '/VERYSILENT', '/DIR=C:\R'
          echo "C:\R\bin" >> $env:GITHUB_PATH

      - name: Install Rtools45
        run: |
          curl -L -o rtools45-installer.exe https://github.com/r-hub/rtools45/releases/download/latest/rtools45-aarch64.exe
          Start-Process -Wait -FilePath .\rtools45-installer.exe -ArgumentList '/VERYSILENT'

      - name: Install R Packages Required For Tests
        run: |
          Rscript -e "install.packages(c('data.table', 'dplyr', 'rstudioapi', 'tibble', 'haven', 'R6', 'survival'), repos = 'https://cloud.r-project.org')"

      - name: Build
        run: |
          cargo build

      - name: Run Tests
        env:
          NEXTEST_PROFILE: "ci"
        run: |
          cargo nextest run
